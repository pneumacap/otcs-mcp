# Production overrides — usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Required env vars in .env:
#   POSTGRES_PASSWORD, NEXTAUTH_SECRET, NEXTAUTH_URL, ANTHROPIC_API_KEY,
#   ENCRYPTION_KEY, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, DOMAIN

services:
  caddy:
    image: caddy:2-alpine
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      DOMAIN: ${DOMAIN:?Set DOMAIN in .env}
    depends_on:
      - app
    restart: unless-stopped

  postgres:
    restart: unless-stopped
    volumes:
      - pgdata:/var/lib/postgresql/data

  app:
    restart: unless-stopped
    ports: []  # Remove direct port exposure — Caddy handles it
    expose:
      - '3000'
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-altius}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-altius}
      NEXTAUTH_URL: https://${DOMAIN}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:?Set NEXTAUTH_SECRET in .env}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:?Set ANTHROPIC_API_KEY in .env}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:?Set ENCRYPTION_KEY in .env}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}

volumes:
  caddy_data:
  caddy_config:
